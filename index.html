<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚µãƒ¼ãƒãƒ¼ä»˜ããƒ–ãƒ­ã‚°</title>
<style>
body{font-family:Arial;max-width:700px;margin:auto;padding:20px;}
input, textarea{width:100%;padding:8px;margin-bottom:10px;}
button{padding:6px 10px;margin:2px;}
.post, .comment{border:1px solid #ccc;padding:8px;margin-bottom:8px;}
.ad{background:#f0f0f0;padding:5px;margin:5px 0;text-align:center;}
#message{color:green;}
#error{color:red;}
</style>
</head>
<body>

<h1>ã‚µãƒ¼ãƒãƒ¼ä»˜ããƒ–ãƒ­ã‚°</h1>

<div id="authSection">
  <h2>ç™»éŒ² / ãƒ­ã‚°ã‚¤ãƒ³</h2>
  <input type="text" id="username" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
  <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
  <button onclick="register()">ç™»éŒ²</button>
  <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <div id="authMessage"></div>
</div>

<div id="postSection" style="display:none;">
  <h2>æ–°ã—ã„æŠ•ç¨¿</h2>
  <input type="text" id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
  <textarea id="content" rows="3" placeholder="æœ¬æ–‡"></textarea>
  <input type="file" id="image">
  <button onclick="addPost()">æŠ•ç¨¿</button>
  <hr>
  <h2>æŠ•ç¨¿ä¸€è¦§</h2>
  <div id="postsContainer"></div>
</div>

<script>
const API = "/api"; // ã‚µãƒ¼ãƒãƒ¼ã¨åŒã˜URLã«ã‚¢ã‚¯ã‚»ã‚¹

let token = null;

/* ===== ç™»éŒ² ===== */
function register(){
  const u=document.getElementById("username").value.trim();
  const p=document.getElementById("password").value.trim();
  const msg=document.getElementById("authMessage");
  if(!u||!p){ msg.textContent="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¿…é ˆ"; return;}
  fetch(`${API}/register`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username:u,password:p})
  }).then(r=>r.json()).then(d=>{
    if(d.error){ msg.style.color="red"; msg.textContent=d.error; }
    else{ msg.style.color="green"; msg.textContent="ç™»éŒ²æˆåŠŸ"; }
  });
}

/* ===== ãƒ­ã‚°ã‚¤ãƒ³ ===== */
function login(){
  const u=document.getElementById("username").value.trim();
  const p=document.getElementById("password").value.trim();
  const msg=document.getElementById("authMessage");
  fetch(`${API}/login`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({username:u,password:p})
  }).then(r=>r.json()).then(d=>{
    if(d.error){ msg.style.color="red"; msg.textContent=d.error; return;}
    token = d.token;
    document.getElementById("authSection").style.display="none";
    document.getElementById("postSection").style.display="block";
    loadPosts();
  });
}

/* ===== æŠ•ç¨¿ ===== */
function addPost(){
  const title = document.getElementById("title").value.trim();
  const content = document.getElementById("content").value.trim();
  const imageFile = document.getElementById("image").files[0];
  if(!title || !content) return;
  const form = new FormData();
  form.append("title",title);
  form.append("content",content);
  if(imageFile) form.append("image", imageFile);
  fetch(`${API}/posts`,{
    method:"POST",
    headers:{Authorization:"Bearer "+token},
    body:form
  }).then(()=>{ document.getElementById("title").value=""; document.getElementById("content").value=""; loadPosts(); });
}

/* ===== æŠ•ç¨¿ä¸€è¦§ ===== */
function loadPosts(){
  fetch(`${API}/posts`).then(r=>r.json()).then(posts=>{
    const container = document.getElementById("postsContainer");
    container.innerHTML="";
    posts.forEach(p=>{
      const div = document.createElement("div");
      div.className="post";
      div.innerHTML=`
        <h3>${p.title} by ${p.username}</h3>
        <p>${p.content}</p>
        ${p.image ? `<img src="${p.image}" style="max-width:100%;">` : ""}
        <button onclick="likePost(${p.id})">ğŸ‘ ${p.likes}</button>
        <button onclick="addComment(${p.id})">ã‚³ãƒ¡ãƒ³ãƒˆ</button>
        <div class="comments" id="comments-${p.id}"></div>
        <div class="ad"><a href="#" onclick="adClick(${p.id});return false;">åºƒå‘Šãƒªãƒ³ã‚¯ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¨ˆæ¸¬ï¼‰</a></div>
      `;
      container.appendChild(div);
      loadComments(p.id);
    });
  });
}

/* ===== æŠ•ç¨¿ã„ã„ã­ ===== */
function likePost(id){
  fetch(`${API}/posts/${id}/like`,{method:"POST", headers:{Authorization:"Bearer "+token}}).then(()=>loadPosts());
}

/* ===== ã‚³ãƒ¡ãƒ³ãƒˆ ===== */
function addComment(postId){
  const txt = prompt("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›");
  if(!txt) return;
  fetch(`${API}/comments`,{
    method:"POST",
    headers:{"Content-Type":"application/json", Authorization:"Bearer "+token},
    body:JSON.stringify({post_id:postId,comment:txt})
  }).then(()=>loadComments(postId));
}

function loadComments(postId){
  fetch(`${API}/comments?post_id=${postId}`).then(r=>r.json()).then(comments=>{
    const div = document.getElementById("comments-"+postId);
    div.innerHTML="";
    comments.forEach(c=>{
      const cdiv = document.createElement("div");
      cdiv.className="comment";
      cdiv.innerHTML=`${c.username}: ${c.comment} <button onclick="likeComment(${postId},${c.id})">ğŸ‘ ${c.likes}</button>`;
      div.appendChild(cdiv);
    });
  });
}

function likeComment(postId, commentId){
  fetch(`${API}/comments/${commentId}/like`,{method:"POST", headers:{Authorization:"Bearer "+token}}).then(()=>loadComments(postId));
}

/* ===== åºƒå‘Šã‚¯ãƒªãƒƒã‚¯ ===== */
function adClick(postId){
  fetch(`${API}/ads/${postId}/click`,{method:"POST"}).then(()=>alert("åºƒå‘Šã‚¯ãƒªãƒƒã‚¯è¨ˆæ¸¬ã•ã‚Œã¾ã—ãŸ"));
}
</script>
</body>
</html>
